// text.js - v0.31 深度差异化文案版
import { DB } from './data.js';

function randomChoice(arr) { 
    if (!arr || arr.length === 0) return "……";
    return arr[Math.floor(Math.random() * arr.length)]; 
}

// --- 关系状态判定引擎 ---
function getRelationState(p, isSpouse) {
    if (window.gameState.isPlayerImprisoned && p.id === window.gameState.captorId) return "captor";
    if (p.isImprisoned) return "imprisoned";
    
    // 痴绝特殊判定：好感度高时容易触发 crush (表现为病态依恋)
    if (p.personality.name === "痴绝" && p.love > 60) return "crush"; 
    
    // 【修改】爱恨交织状态 (Love-Hate)
    // 条件：爱意 > 50 但好感 < -10，或者虽然是仇敌(isNemesis)但爱意 > 50
    if (p.love > 50 && (p.favor < -10 || p.isNemesis)) return "love_hate"; 
    
    // 仇敌状态
    if (p.favor < -20 || p.isNemesis) return "enemy";
    
    // 伴侣/至爱
    if (isSpouse || p.love > 80) return "lover"; 
    
    // 暧昧/暗恋
    if (p.love > 30) return "crush"; 
    
    // 朋友
    if (p.favor > 30) return "friend"; 
    
    return "stranger"; // 默认路人
}

// --- 全新文案库 (8性格 x 全状态 x 多条轮换) ---
const NEW_DIALOGUE_LIB = {
    // 1. 疏狂 (Trickster) - 玩世不恭，乐子人
    "疏狂": {
    stranger: [
        "他懒散地倚在树旁，眼神在你身上打了个转，似乎在评估你是否是个有趣的人。",
        "他仰头灌了一口酒，对修仙界繁复的规矩显得毫无耐心。",
        "他挥了挥手示意你让开，嫌你的身影挡住了他看云。",
        "他敲了敲腰间空荡荡的酒壶，暗示若无美酒，便不必继续攀谈。",
        "他对着夕阳出神，对你的靠近几乎没有反应。",
        "他打了个哈欠，随手指了个方向，明显是在把你打发走。"
    ],
    captor: [
        "他拎着酒壶歪斜地靠在石柱旁，影子被火光拉得极长。，眸光扫过你被缚的双足，闪过一抹戾气。",
        "他斜倚在门槛上，任由满身血气在密闭的空间内肆意蔓延，并不与你说话，也并未喝酒。"
    ],
    friend: [
        "他扫了你一眼，语气轻快地提议逃掉正经事，去后山找点乐子。",
        "他上下打量了你一番，像是在调侃你身上的无趣，却又并不嫌弃。",
        "他兴致勃勃地提起自己新写的话本，似乎很乐意让你第一个翻看。",
        "他招呼你一起去坊市凑热闹，对新来的戏班子颇感兴趣。",
        "他对修炼的枯燥表现出明显厌倦，顺势拉你一起沉入一场白日梦。"
    ],
    crush: [
        "他看向你的目光多停留了一瞬，似乎连一向看淡的长生之事都变得没那么虚无。",
        "他半真半假地提起把你写进话本，话语里藏着过界的试探。",
        "他目光清明地看着你，像是在纷乱红尘中难得找到了安静的存在。",
        "他忽然抛出一个离经叛道的提议，语气轻佻，却并非全然玩笑。"
    ],
    lover: [
        "他提起世人对自己的评价，语气里带着自嘲，却明显将你视作例外。",
        "他懒洋洋地倚在你肩上，对长生与世俗皆显得兴致缺缺。",
        "他看着你，仿佛整个世界因此变得宜居而温和。",
        "他抬头看了眼月色，语气暧昧地暗示夜晚并不打算安分。"
    ],
    love_hate: [
        "他警告你别再那样看他，情绪在失控的边缘摇晃。",
        "他提到你的名字时明显停顿了一下，对自己的反应感到恼火。",
        "他盯着手中的酒，语气冷淡地直言这酒的味道正如你给他的感觉一样，辛辣且令人生厌。",
        "他低声让你离开，显然是在强压着想毁掉你的冲动。"
    ],
    enemy: [
        "他皱眉看着你，神情厌恶到连酒都显得索然无味。",
        "他毫不掩饰对你伪善姿态的反感。",
        "他手已按上剑柄，明确表示耐心所剩无几。",
        "他用刻薄的评价否定了你存在的意义。"
    ],
    imprisoned: [
        "他打量着困住自己的地方，语气里反倒透着几分兴味。",
        "即使身陷囹圄，他仍自顾自地哼着不成调的小曲。",
        "他看着牢笼，轻描淡写地否定了它的意义。"
    ],
    demonic: [
        "他陷入失控的狂笑中，将一切现实与秩序全盘否定。",
        "他被血色刺激得兴奋异常，情绪彻底滑向疯狂。"
    ],
    woohoo_normal: [
        "他轻挑地勾起你的下巴，感叹良辰美景转瞬即逝，不如趁现在及时行乐，讨个痛快。",
        "他慢条斯理地解开衣带，语气轻佻地拉你越过正经界限。"
    ],
    woohoo_force: [
        "他笑得近乎失控，神情癫狂地拉你一起沉沦，像是把亲密当成一场互相消耗的博弈。",
        "他语气空洞地放弃身体的意义，显露出早已破碎的内里。"
    ],
    reject_woohoo: [
        "他摆了摆手，显然兴致不在此处。",
        "他看穿了你的意图，语气嫌弃地否定了这份直白。"
    ],
    breakup: [
        "他洒脱地举杯，表示合则聚不合则散，待这壶酒尽，往昔情分便一笔勾销，从此两不相欠。",
        "他对这场持续已久的戏码表现出明显倦意，是时候各走各路了。"
    ],
    reject_breakup: [
        "他语气轻佻却态度强硬，显然不打算就此散场。",
        "他用你未曾预料的极端口吻否定了分开的可能。"
    ],
    reject_pregnancy: [
        "他对眼下的状况表现出明显抗拒，直言扫兴。",
        "他情绪烦躁地躲开你的触碰，对身体的不适毫不掩饰。"
    ]
},

    // 2. 骄阳 (Youth) - 坦荡热烈，小太阳
"骄阳": {
    stranger: [
        "他爽朗地笑了一声，自报身份，神情坦荡，没有半点戒备。",
        "他拍了拍你的肩膀，指着前方的漫漫长路，鼓励你别为了这点小挫折垂头丧气。",
        "他上下打量了你一眼，毫不吝啬地夸赞你的资质，态度真诚又热情。",
        "他一边招呼一边往前冲，生怕你挡住了他行侠仗义的去路。"
    ],
    captor: [
       "他投下的阴影将你彻底覆盖,伸手试图触碰你的脸，却在半空生生停住，不知在犹豫什么。",
        "他的靴子在台阶上撞击出暴戾的重响，曾经的少年如今像一个困兽。"
    ],
    friend: [
        "他拍着胸脯向你保证，只要你开口，再危险的事也愿意陪你去闯。",
        "他兴冲冲地递上一把寒光凛冽的长剑，认真地觉得这把剑的英气正配你的气质。",
        "他兴冲冲地提议下次历练一起行动，语气里满是跃跃欲试。",
        "他见你情绪低落，二话不说就要拉你去寻找城里最好吃的馆子。",
        "他大笑着承认你这个朋友，态度直白又毫不扭捏。"
    ],
    crush: [
        "他说话时明显有些不自在，目光却总忍不住往晚霞和你之间来回。",
        "他提到变强时语气格外认真，话里话外都绕着你的安危。",
        "你一靠近，他下意识按住胸口，反应快得不像是刻意，但你还是听到了剧烈的心跳声。",
        "面对你突如其来的笑颜，他立刻移开视线，整个人像是被晒过头了一样。"
    ],
    lover: [
        "他毫不犹豫地表明立场，把这段关系看得又重又笃定。",
        "他紧紧握住你的手，情绪高涨得仿佛力气真的源源不断。",
        "他语气坚定地把未来的所有可能都一并揽下，没有丝毫迟疑。",
        "他嘿嘿傻笑着凑过来，眉眼间尽是藏不住的幸福，感叹能与你相识是他此生最幸运的事。"
    ],
    love_hate: [
        "他情绪失控地质问你，那双曾经满是信任的眼中此刻写满了破碎与不可置信。",
        "他在你靠近时猛地后退，握剑的手微微颤抖，在杀意与不舍的极端挣扎中痛苦不堪。",
        "他近乎执拗地要求你变回从前，语气里满是崩塌的期待。",
        "他红着眼看向你，恨意与眷恋混在一起，谁也压不下去。"
    ],
    enemy: [
        "他站得笔直，明确划清立场，语气不再留任何余地。",
        "他毫不掩饰对你行事作风的厌恶，态度锋利而直接。",
        "他承认自己曾看错了人，转而以对手的身份直面你。",
        "他怒气冲冲地让你滚开，连多看一眼都觉得脏了眼。"
    ],
    imprisoned: [
        "他仰着头放出狠话，态度倔强，没有丝毫求饶的意思。",
        "他被关着，却依旧目光明亮，显然不觉得这能动摇自己。",
        "他反复提起终有一日会堂堂正正离开，语气笃定而执拗。"
    ],
    demonic: [
        "他被体内翻涌的诡气折磨得失去控制，痛苦与混乱一并爆发。",
        "他在崩溃中怒吼，随即便陷入了毁掉一切的癫狂。"
    ],
    woohoo_normal: [
        "他脸涨得通红，虽然动作因羞涩而稍显笨拙，却透着一股赤诚的热情。",
        "他紧紧地拥着你，满足地叹息着，觉得只要是和你在一起，无论做什么都是最好的安排。"
    ],
    woohoo_force: [
        "他拼命挣扎，眼中满是震惊与抗拒，完全无法理解你的行为。",
        "他在屈辱中紧闭双眼，冰冷地推拒着你的碰触，厌恶几乎要溢出言语之外。"
    ],
    reject_woohoo: [
        "他慌乱地找了个练剑的理由，几乎是落荒而逃。",
        "他涨红了脸把话题推开，对这种直白显得手足无措。"
    ],
    breakup: [
        "他强撑着情绪祝你未来更好，眼眶却已经红了一圈。",
        "他把被抛下的委屈全数抛给你，语气倔强又不甘。"
    ],
    reject_breakup: [
        "他拒绝接受你的说法，一口咬定这是谎言。",
        "他急切地追问自己的问题，语气里满是恐慌与挽留。"
    ],
    reject_pregnancy: [
        "他紧张地把所有注意力都放在安全上，态度罕见地强硬。",
        "他下意识护住腹部，把优先顺序说得一清二楚。"
    ]
},

    // 3. 清贵 (Noble) - 矜贵自傲，掌控欲，高岭之花
"清贵": {
    stranger: [
        "他目光淡漠地扫过你，态度疏离而克制，显然很在意修仙界的秩序与分寸。",
        "他简单评价了你的修为与气度，态度淡淡，既不夸耀也不否定。",
        "他让你让开去路，语句简短，没有多余解释。",
        "他对散修的失礼表现出明显的不悦，却懒得多说。"
    ],
    captor: [
        "曾经不染尘埃的白衣如今委地而坐，清冷的眉眼间尽是支离破碎的颓丧。",
        "不该囚禁你的，但仍这么做了，也知道再也不可能得到你的原谅。"
    ],
    friend: [
        "他将多余炼成的丹药交给你，语气理所当然，不接受推辞。",
        "他指出你修行中的不足，并允许你在需要时向他请教，态度带着居高临下的关照。",
        "他得知你被人冒犯后，直接示意你报出他的名号，显然对此颇有把握。",
        "他品着茶，准许你多留一会儿，算是一种难得的放松。",
        "他对你的出身不置可否，却承认你的悟性勉强合格。"
    ],
    crush: [
        "他罕见地承认你超出了他的预期，在评价中给你留了位置。",
        "他示意你不必亲自处理琐事，语气冷静，却已经开始替你安排。",
        "他将一件防御法器交到你手中，理由充分而直接。",
        "他让你站在自己身后，将所有风险自然地划入自己的责任范围。"
    ],
    lover: [
        "他明确宣示你的归属，同时也不掩饰对你行踪的掌控。",
        "他理所当然地接过你手中的杂务，将你的角色重新安置到更高的位置。",
        "他提及姓氏与身份的结合，将关系上升为公开而正式的存在。",
        "他将写满天下珍奇的清单递给你，眼神暗示只要你开口，这些就为你而存在。"
    ],
    love_hate: [
        "他死死盯着你，指关节因用力而发白，随即露出一个令人胆寒的冰冷笑意。",
        "他清楚地提醒你，自己既能抬举，也能毁灭，不容试探。",
        "他捏住你的下巴迫使你抬头，目光冰冷，试图从你眼中找出一丝悔恨的痕迹。",
        "他冷嘲自己竟会被你这种人牵动情绪，语气中满是讽意。"
    ],
    enemy: [
        "他居高临下地审视你，将你明确划入不可并列的存在。",
        "他甚至懒得正眼看你，将无视当成最大的不屑。",
        "他直言你的存在本身就令人不快。",
        "他冷笑一声斜睨着你，将胜负视作无需讨论的结果。"
    ],
    imprisoned: [
        "他对暂时的失势表现得异常镇定，显然并不认为这足以动摇根本。",
        "即便身处牢狱，他仍像在审视领地一般，对环境提出要求。",
        "他否定了这种境遇对自己的侮辱意义，态度冷静而笃定。"
    ],
    demonic: [
        "他将众生一并贬为蝼蚁，杀意不带任何情绪波动。",
        "他冷眼看着这混乱的世道，选择以最彻底的方式清洗。"
    ],
    woohoo_normal: [
        "他掩去眼底那一抹局促，以近乎命令的姿态倾身而上，索要你的全然专注。",
        "他在你耳边低语，虽是温存的姿态，手上的掌控力度却容不得你半分退缩。"
    ],
    woohoo_force: [
        "他紧闭双眼，任凭泪水无声滑落，僵硬地承受着这一切。",
        "他放弃身体的主权，偏过头去不再看你，任你施为。"
    ],
    reject_woohoo: [
        "他冷淡地拂开你的手，整理好压褶的衣襟，当即否决了你的提议。",
        "他盘膝而坐进入冥想状态，语气肃穆地提醒你修仙者应当时刻克制私欲。"
    ],
    breakup: [
        "他在情感断裂时表现得异常冷静，直接结束对话。",
        "他将选择权还给你，却同时封死了回头的可能。"
    ],
    reject_breakup: [
        "他拒绝承认这种单方面的决定，将其视为对自身威望的挑战。",
        "他以归属与身份为由，彻底否定了分离的选项。"
    ],
    reject_pregnancy: [
        "他严厉制止任何可能影响胎气的行为，将责任明确压下。",
        "他当即重新安排起居，将一切纳入自己的规划之中。"
    ]
},

   // 4. 守心 (Ascetic) - 禁欲克制，道心唯上
"守心": {
    stranger: [
        "他正在独自参悟道法，对你的靠近未作任何反应，周身散发着生人勿近的肃穆感。",
        "他如雕塑般纹丝不动，目光径直穿过你的身影，仿佛你并不存在。",
        "他微微颔首示意，在擦肩而过时特意侧身避开了衣角的触碰。",
        "他对红尘喧嚣表现出明显的疏离与排斥。"
    ],
    captor: [
        "满地的断珠是他无法平息的罪孽，他闭眼在佛前求自己速死。",
        "他困住了你，却也将自己的魂灵永远钉在了地狱里。"
    ],
    friend: [
        "他对着你略作打量后露出一抹清浅的笑意，似是在赞许你近期的长进。",
        "他在茶桌对面正襟危坐，指了指你手中的茶杯，示意你平复浮躁的气息。",
        "他从袖中取出一本微黄的古籍推到你面前，那是他为你亲手誊抄的清心咒。",
        "他为你斟上一盏清茶，神色宁静地坐在那儿，似乎在等你在茶香中忘却凡尘。",
        "他虽自称不问世事，却仍愿意为你的请求破例出手。"
    ],
    crush: [
        "他闭目诵经，呼吸却明显乱了节奏，显然无法完全入定。",
        "面对你的靠近，他下意识地后退了半步，他意识到自己的道心开始动摇，却找不到平复的方法。",
        "他慌乱地避开你的直视，试图重新稳定自身心绪。",
        "他紧闭双眼，嘴唇无声地翕动，似乎在向道心忏悔。"
    ],
    lover: [
        "他将你重新定义为自己的道途本身，转身牵起你的手，眼中再无半分挣扎。",
        "他任由你靠在他的身上，目光专注而温情，似乎已修得了圆满。",
        "他为你换上了世俗的艳装，站在长街的人潮里，眼神片刻不离地跟随着你的身影。",
        "他轻抚你的脸颊，指尖略过你的鬓发，那副破戒后的坦然神色竟带了几分庄严。"
    ],
    love_hate: [
        "他将你视为渡不尽的劫数，这让他感到痛苦。",
        "他质问你带来的动摇，却得不到任何解脱的答案。",
        "他无法对你下手，也无法再维持原有的道心。",
        "他猛然挥袖将你推开，眼神中闪过一丝挣扎的惊恐与痛苦。"
    ],
    enemy: [
        "他目光悲悯却冰冷，认为你无可救药。",
        "他对你的话语置若罔闻，制止任何可能扰乱自己心境的行为。",
        "他以道途不同为由，明确拒绝继续交集。",
        "他将你的存在视为对世道的破坏因素。"
    ],
    imprisoned: [
        "他盘膝而坐，在囚禁中依然保持修行状态。",
        "他将眼前的困境视作虚幻之相，不予执着。",
        "他区分了肉身与道心，对现状并不动摇。"
    ],
    demonic: [
        "他在道心崩塌中否定了曾经坚信的一切。",
        "他以极端的方式回应被放弃的信仰，彻底堕入魔道。"
    ],
    woohoo_normal: [
        "他在情动之时仍试图维持理智，却又无法拒绝地向你沉沦。",
        "他闭上双眼，在混乱的呼吸间低声唤着你的名字。"
    ],
    woohoo_force: [
        "他强行承受这一切，紧咬牙关不肯漏出一丝声音，将修行受损视作既定事实。",
        "他将身体与意志分离，拒绝在情感上回应。"
    ],
    reject_woohoo: [
        "他以修行为由拒绝接触，指了指窗外的月色示意你应当静心。",
        "他默不作声地背过身，用一种近乎惩罚的克制拒绝了你的亲近。"
    ],
    breakup: [
        "他将关系的结束视为因果流转的一部分。",
        "他选择回归清修，神色间恢复了最初的冷淡，仿佛两人从未有过任何纠葛。"
    ],
    reject_breakup: [
        "他紧紧扣住你的手腕，力道大得惊人，语气中带着一抹因恐惧失去而产生的执念。",
        "他挡在你身前，神色凝重地凝视着你，似乎要把你强行扣在这场因果里。"
    ],
    reject_pregnancy: [
        "他基于安全与克制的考量，搬起坐垫坐到房间的最远端。",
        "他神色坚决地摇了摇头，拒绝任何越界行为。"
    ]
},

    // 5. 市侩 (Pragmatist) - 精致利己，现实主义
"市侩": {
    stranger: [
        "他眯起眼从头到脚掂量着你的行头，像是在心里飞快地盘算你这身装备能值多少灵石。",
        "他意兴阑珊地摆了摆手，示意没油水可捞的差事别去烦他。",
        "他不耐烦地示意你让开，你的存在妨碍了他眼前正在进行的生意。",
        "他注意到你这张生面孔，顺势抛出一桩买卖，语气里满是试探与算计。"
    ],
    captor: [
       "他为你寻来稀世珍宝堆满囚室，好像如此你就能成为他的金丝雀。",
        "他机械地擦拭着那些沉重的金锁，觉得这些漂亮的锁链才与你相配。"
    ],
    friend: [
        "他压低声音告诉你，这个消息只对你开放，价格也“友情”地打了折。",
        "他一边强调你们的交情，一边把账目算得清清楚楚，丝毫不肯含糊。",
        "他勉强承担了这次开销，却不忘提醒你，下次该轮到你回请。",
        "他暗示若再想让他出手替你摆平麻烦，可不能像这次一样什么也不给了。",
        "他美滋滋地数着刚分得的战利品，对与你的合作显得格外满意。"
    ],
    crush: [
        "他半真半假地把你们的关系形容成一笔稳赚不赔的买卖，说得自己都快信了。",
        "他递给你一件珍藏的随身物件，神色虽有些肉疼，却还是利落地帮你扣紧。",
        "他含糊地承认，最近你在他眼里的价值，似乎已经超过了灵石。",
        "他盯着你看了一会儿，随后低头感叹你比金子还晃眼。"
    ],
    lover: [
        "他把自己压箱底的灵石袋全堆在你面前，虽然习惯性地咳嗽了一声，却还是把钱袋推向你。",
        "他把厚厚的账本端端正正地递给你，放心地拍了拍手，示意从此由你掌管财政大权。",
        "他坦言，在这个世界上，能让他认真对待的东西本就不多，而你占了一席。",
        "他以交易的口吻许下极端的忠诚，仿佛连对你的感情几乎与性命等价。"
    ],
    love_hate: [
        "他承认，与你纠缠是自己做过最亏的一桩买卖，却又迟迟无法止损。",
        "他情绪失控地要求你归还情感与付出，试图把一切折算成可结清的数目。",
        "他把你形容成一笔怎么也对不平的烂账，越算越乱，神色间尽是挣扎。",
        "他在你谈及旧情时猛地捂住钱袋，神色警惕，一副拒绝为这段感情再多掏一分钱的架势。"
    ],
    enemy: [
        "他把你视为断他财路的仇人，语气里满是毫不掩饰的敌意。",
        "他嫌恶地拍掉被你碰过的衣角，对着你的背影啐了一口，毫不掩饰对你这穷酸相的鄙夷。",
        "他一边摩挲着厚重的钱袋，一边阴森森地打量着你的脖子，似乎在估算买你这条命的价格。",
        "他警告你不要再出现在他面前，否则后果自负。"
    ],
    imprisoned: [
        "身陷囹圄的他第一反应仍是谈条件，急切地估算脱身的价格。",
        "他不断强调只要活着，一切损失都还有翻盘的可能。",
        "在绝境中，他依旧坚信自己终有东山再起的一天。"
    ],
    demonic: [
        "他的神志几乎被贪念吞噬，眼中只剩下对财富的疯狂执着。",
        "他近乎失控地攥着地面，反复确认一切都属于自己。"
    ],
    woohoo_normal: [
        "他嘿嘿一笑，神神秘秘地翻出一本号称双修秘籍的古书，兴致勃勃地要拉你一同实操。",
        "他动作麻利地铺好床褥，有些讨好地冲你眨眨眼，表示今晚这一次算他白送的福利。"
    ],
    woohoo_force: [
        "他面色阴沉地盯着天花板，在屈辱中强行记下这笔账。",
        "他他在你触碰时发出一声冷笑，把这次被迫的付出视为一笔高利贷，迟早要连本带利讨回。"
    ],
    reject_woohoo: [
        "他瘫在椅子上一副虚弱的模样，却在看到你拿出灵石后眼神微亮，随即又故作矜持地推开。",
        "他头也不抬地埋首在账堆里，指了指窗外，示意别打扰他处理那些关乎命脉的利钱。"
    ],
    breakup: [
        "他翻开一份详尽的清单，指着上面的每一项花销要求你清算结清，散伙就要公事公办。",
        "他面无表情地算完最后一笔账，利索地卷起铺盖走人，眼神里再无半分留恋。"
    ],
    reject_breakup: [
        "他抖出一张签了名字的契约纸，指着上面的违约条款，冷笑着示意你想走就得赔个底掉。",
        "他死死拉住你的袖子不肯松手，神情像是在挽回一笔即将血亏的大单子，绝不容许毁约。"
    ],
    reject_pregnancy: [
        "他如临大敌地护着肚子，连让你碰都不准碰一下，生怕一个不留神就撞坏了他的“未来保障”。",
        "他忙不迭地往后缩，神色紧绷，坚决拒绝这种可能导致“血本无归”的高风险尝试。"
    ]
},

    // 6. 孤绝 (Loner) - 纯动作陈述版
"孤绝": {
    stranger: [
        "他默不作声地退开半步，垂下眼帘避开视线接触，整个人陷进阴影里。", 
        "他警觉地扫过你的双手，确认并无杀机后，重新压低了斗笠。",
        "他侧身让出行路空间，身体紧贴墙缘，极力避免任何肢体擦碰。",
        "他双臂交叉抱剑立在暗处，呼吸微不可闻，宛如一尊灰冷的石雕。"
    ],
    captor: [
        "他像一尊石像守在角落，闭着眼睛，不想看到你现在的神情。",
        "他在黑暗中无声地呕出一口淤血，并不看你，但也不离开。"
    ],
    friend: [
        "他生硬地将一颗沾着露水的灵果塞进你手里，随即迅速飞身上远处的树冠。", 
        "听闻你受了委屈，他原本平直的嘴角微微下压，指尖已下意识地扣住剑柄。",
        "面对你的关心，他从喉咙深处发出一声低促的应和，目光比往日柔软了些许。",
        "他一言不发地翻出随身最珍贵的金创药，半跪在地上，轻缓地将其搁在你脚边。",
        "他在前方默默拨开横生的荆棘，每走几步便会停下，确认你是否跟在身后。"
    ],
    crush: [
        "他始终保持着三步远的距离跟在你身后，被回头注视时，他慌乱地低头数着地上的砖缝。", 
        "他远不近地注视着你的背影，眼神清澈而固执，似乎外面的万千世界都与他无关。",
        "他将自己视若生命的佩剑横放在你膝头，以此作为他唯一拿得出手的守护方式。",
        "他在被你偶然触碰指尖时猛地缩手，从颈根到耳尖迅速洇开一片扎眼的血红。"
    ],
    lover: [
        "他单膝跪在你面前，神色肃穆地将你的手贴在自己心口，眼神示意愿供差遣。", 
        "他张开双臂把你护在怀中，背部紧绷，用身体屏蔽了外界所有的风雨。",
        "他专注地凝视着你的眼睛，虽然一言不发，但眼底那抹视死如归的忠诚已说明了一切。",
        "他在你归家时默默接过行囊，身形逐渐放松，仿佛在此处才拥有了归属感。"
    ],
    love_hate: [
        "他像是一只被丢弃的幼兽，眼神破碎地望着你，手中那把无往不利的剑颓然落地。",
        "他在你靠近时如遭电击般战栗，侧过脸去不看你发红的眼眶，以此拒绝最后的温存。",
        "他用力按压着胸前的旧伤口，脸色惨白，似乎在承受比肉体撕裂更甚万倍的剧痛。",
        "他握剑的手剧烈地颤抖着，在失控之前，他决绝地指了指门外，示意你立刻离开。"
    ],
    enemy: [
        "他眼底毫无波澜，只是冷冷地吐出一个字音，右手虎口缓缓推开了剑格。", 
        "他在身形掠出的瞬间拔剑出鞘，没有任何废话，剑锋带起的寒气直逼你咽喉。",
        "他挡在必经之路上，眼神中既无恨意也无怜悯，只是像处理障碍物一样锁定了你。",
        "他在你剑下留了一寸余地，收剑入鞘后留给你一个肃杀的背影，暗示下次必是死期。"
    ],
    imprisoned: [
        "他在囚室的枯草上蜷缩着身体，独自处理着崩开的伤口，像极了一头拒绝靠近的野兽。", 
        "看到你出现时，他死寂的眸子里掠过一抹微光，即便铁链作响，他也努力想坐得端正些。",
        "他不发一言地靠在潮湿的石墙上，神色木然地盯着虚空，似乎早已习惯了无止境的孤独。"
    ],
    demonic: [
        "他完全丧失了理性的光芒，喉咙里发出野兽般的低吼，不分敌我地向所有活物挥剑斩下。",
        "他在血泊中疯狂地撕咬着绷带，双目赤红，发出的嘶吼声里满是濒死的绝望与暴戾。"
    ],
    woohoo_normal: [
        "他动作生涩地环住你，像是在触碰一件易碎的瓷器，眼神里写满了小心翼翼的渴求。",
        "他伏在你肩头，呼吸急促而杂乱，笨拙地调整着姿态，试图找到更舒适的角度。"
    ],
    woohoo_force: [
        "他身体僵硬如铁，却在觉察到你的力道时强行放松了肌肉，唯恐反抗时会不慎伤人。",
        "他闭上双眼，任由泪水无声地没入鬓角，在一种近乎自虐的顺从里彻底放弃了尊严。"
    ],
    reject_woohoo: [
        "他动作僵硬地扯过衣襟，逃也似地转过身去，只留给你一个通红的后脑勺。",
        "他轻轻推开你的手，指了指自己那双因失控而布满血丝的眼，眼神满是担忧。"
    ],
    breakup: [
        "他默默听完你的话，垂头沉默了许久，最后利索地收拾好那个干瘪的行囊，消失在夜色中。",
        "他把所有能防身的宝物都整齐地码在桌上，没留下一张字条，就这样无声无息地离开了。"
    ],
    reject_breakup: [
        "他像尊石狮子般死死守住大门，神情执拗，任凭你如何推搡也始终纹丝不动。",
        "他死死拽住你的衣角跪在原地，仰头望着你，眼神里充满了如剑断人亡般的绝望。"
    ],
    reject_pregnancy: [
        "他如临大敌地盯着你,神色紧张地连连摇头。",
        "他像护崽的猛兽般守在床榻边，用宽大的手掌虚隔在两人之间，坚决拒绝任何越界举动。"
    ]
},

    // 7. 温润 (Gentle) - 温柔包容，老好人
    "温润": {
        stranger: [
            "他露出如沐春风的微笑，侧身指向一旁的石凳，示意你在此歇息。", 
            "他轻轻颔首，眼神温和地注视着你，仿佛在庆幸这场不期而遇。",
            "他停下手中的动作，略带关切地倾过身，询问你是否遇到了难处。",
            "他抬头看了看渐沉的暮色，温声叮嘱你路上当心，并目送其远去。"
        ],
        captor: [
       "他每天都轻声哄你吃饭，但你总是将头扭向一边，并不理他。",
        "他温柔地为你拭去足尖的尘埃，眼泪却先一步砸在你的脚背上，烫得惊人。"
    ],
        friend: [
            "他在你肩头轻轻搭了一件披风，细声叮嘱修行之余莫要贪功伤身。", 
            "他坚定地站在你身侧，微微侧头示意，无论局面如何都会并肩应对。",
            "他端出一壶温热的桃花酿，眉眼含笑地为你斟满，示意尝尝新酿的滋味。",
            "他无奈地轻叹一声，取出干净的手帕，低头细致地为你包扎伤口。",
            "他仔细确认你并无大碍后，如释重负地松开紧皱的眉头，露出安心的神色。"
        ],
        crush: [
            "他注视着你的笑颜，眼中似有暖阳流淌，连唇角的弧度都变得格外柔软。", 
            "他静静地凝视着你，眼神温柔得几乎能滴出水来，半晌才不自然地移开视线。",
            "他提起一盏纸灯走在你身前，细心地照亮脚下每一寸坎坷的路径。",
            "他将一支精致的发簪别在你发间，反复端详后，露出满意的赞许神色。"
        ],
        lover: [
            "他郑重地执起你的手，十指紧扣，目光中盛满了共度余生的笃定。", 
            "他动作轻柔地理顺你鬓角的碎发，拍了拍自己的肩膀，示意你靠着小憩。",
            "他时刻关注着你的每一个细微神情，似乎只要能换来你的一笑，赴汤蹈火亦在所不惜。",
            "他从背后环抱住你，将头埋在你的颈窝，发出满足且眷恋的长叹。"
        ],
        love_hate: [
            "他眼底透着浓浓的哀伤，却依然礼貌地保持着距离，示意往昔情分已尽。",
            "他捂着胸口的血痕，却颤抖着手去确认你是否被剑锋震痛。",
            "他垂下眼帘发出一声苦笑，颓然地放下试图挽留的手，承认自己终究是一场痴梦。",
            "他闭目掩去眼底的痛楚，侧过身去不再看你，用沉默拒绝了你的再次靠近。"
        ],
        enemy: [
            "他看着你决绝的背影，眼底满是惋惜，无奈地摇了摇头。", 
            "他收起长剑负手而立，试图在战火硝烟中寻找最后一次和平共处的契机。",
            "他看着你激进的动作，眉头微蹙，眼神中透出一丝不认同的克制。",
            "他抬手挡住你的杀招，并不还击，只是轻轻摇头示意你请回。"
        ],
        imprisoned: [
            "他盘坐在阴暗的囚室中，神色坦然地对着铁窗外的你微微一笑，毫无怨怼之色。", 
            "他看着你愤怒的面孔，发出一声带着怜悯的叹息，似乎更担忧你内心的煎熬。",
            "他伸手试图隔着栅栏安抚你焦灼的情绪，语气平静得仿佛此处并非牢笼。"
        ],
        demonic: [
            "他眼底的温柔被扭曲的戾气取代，一边疯狂地笑，一边漫不经心地碾碎周围的一切。",
            "他依旧笑得和煦，指尖却死死扣住旁人的咽喉，神色平静地示意对方安静下来。"
        ],
        woohoo_normal: [
            "他温柔地抚摩着你的背脊，动作极尽怜惜，在耳畔落下轻如羽毛的吻。",
            "他始终注视着你的情绪波动，引导你彻底放松，神色坚定而柔和。"
        ],
        woohoo_force: [
            "他眼中盛满了化不开的悲悯，顺从地摊开身体，任由你将其当作发泄的出口。",
            "他掩去眉宇间的委屈，勉强扯出一抹安抚的笑，试图用这种方式宽慰你的不安。"
        ],
        reject_woohoo: [
            "他体贴地揉捏着你酸痛的肩膀，顺势拉过被褥盖好，示意今晚应当好好休息。",
            "他轻轻握住你作乱的手，摇了摇头，转而提议聊聊今日遇见的趣闻。"
        ],
        breakup: [
            "他深深鞠了一躬，在直起身后露出了一个成全的微笑，只是眼眶迅速变红。",
            "他微笑着擦去你眼角的泪，随后决绝地转身离开，泪水在转身的瞬间滑落。"
        ],
        reject_breakup: [
            "他依旧温和地笑着，手上的力道却大得惊人，固执地不肯松开你的手指。",
            "他温柔地否决了你的提议，眼神中透出一股从未有过的、近乎执拗的占有欲。"
        ],
        reject_pregnancy: [
            "他轻声细语地哄劝你为了孩子暂且忍耐，神色严肃。",
            "他温柔地吻了吻你的额头，起身点燃安神香，用克制的行动平复了暧昧的氛围。"
        ]
    },

    // 8. 痴绝 (Manic) - 动作神态陈述版
    "痴绝": {
        stranger: [
            "他局促地退后半步，目光却像粘在你身上一般，久久不愿离去。", 
            "他低眉顺眼地贴着路边行走，在察觉到你视线时，慌乱地低头行了一礼。",
            "他从怀中掏出一把油纸伞，手忙脚乱地递给你，随后飞快地跑向雨幕深处。",
            "他因自己不经意的冲撞而脸色惨白，不停地作揖道歉，神色惊恐异常。"
        ],
        captor: [
        "他没日没夜地在榻边，双目布满可怖的血丝,像个即将渴死的乞丐，却守着泉水不动。",
        "他将锁链一寸寸缠在自己颈间，另一端系在你的腰间，这种脐带一样的链接方式让他安心了些。"
    ],
        friend: [
            "他捧着一捆珍稀灵草递到你面前，满眼期待地观察你的反应，神态卑微。", 
            "他总是躲在人群边缘，贪婪且小心地注视着你的背影，被发现后立刻缩回阴影。",
            "他听闻你心情欠佳，整日魂不守舍地守在门外，试图寻找任何能献殷勤的机会。",
            "他在说话时不断观察你的脸色，一旦发现你皱眉头，便会立刻诚惶诚恐地噤声。",
            "他站在你身侧时连呼吸都变得小心翼翼，脸上写满了如梦似幻的不真实感。"
        ],
        crush: [
            "他面对你的善意表现得极度不安，反复确认自己是否听错，双手死死拧着衣角。", 
            "他在你对他微笑时猛地僵住，眼神中透出一种近乎绝望的沉溺，半晌不敢动弹。",
            "他拼命练剑，直到筋疲力尽地瘫倒在地，才敢仰头幻想自己能配得上你的幻象。",
            "他低着头避开视线，声音颤抖，在被赶走之前先一步露出了祈求的神色。"
        ],
        lover: [
            "他仰望着你，像是瞻仰唯一的真神，眼中闪烁着近乎狂热的崇拜与迷恋。", 
            "他从背后死死勒住你的腰，浑身颤抖，仿佛只要稍微松手，你就会化作轻烟散去。",
            "他将你所有的旧物都悉心收藏，甚至愿意为了你一个眼神而献祭自己的神魂。",
            "他在睡梦中依旧紧抓着你的衣角，眉头紧锁，似乎在恐惧梦醒后的遗弃。"
        ],
        love_hate: [
            "他歇斯底里地质问着你，眼眶通红，像是一只被彻底踩碎自尊后哀鸣的小狗。",
            "他自残般地划开掌心，盯着流下的血迹，质问你为何如此努力依然会被丢掉。",
            "他眼神空洞地看向远处，手中却变出一副沉重的镣铐，神色在温柔与疯狂间剧烈切换。",
            "他发疯般地堵住大门，神情癫狂，嘶吼着即便同归于尽也绝不准你离开半步。"
        ],
        enemy: [
            "他惨笑着跌坐在地，任由你的剑指着咽喉，露出一副“本该如此”的认命神色。", 
            "他闭上眼睛张开双臂，主动迎向你的锋芒，眼神中竟然带着一丝解脱的快感。",
            "他像是一具失去了发声能力的木偶，任凭你责骂也不还手，眼神死寂如灰。",
            "他在你路过时深深埋下头，双手紧抓泥土，自卑地认为连呼吸都会冲撞到你"
        ],
        imprisoned: [
            "他蜷缩在最黑的角落，抱着膝盖喃喃自语，反复重复着那些自我贬低的咒骂。", 
            "他隔着囚窗贪婪地抚摸你落下的影子，即便被打得遍体鳞伤，神色依旧痴迷。",
            "他拒绝进食，只是呆呆地看着你曾停留过的地方，像是一尊枯萎的干尸。"
        ],
        demonic: [
            "他一边流着血泪一边狂笑，将一切阻碍他视线的障碍物统统轰杀，神态癫狂至极。",
            "他跪在血泊中大口喘息，回头望向你时，眼神中竟然满是邀功般的偏执与狂热。"
        ],
        woohoo_normal: [
            "他极其卑微地俯下身去，亲吻你的指尖，在动作前反复确认你否真的允许。",
            "他死死盯着你的眼睛，在情动时近乎偏执地恳求你亲口确认此时的爱意。"
        ],
        woohoo_force: [
            "他绝望地闭上双眼，像一具祭品般任由你处置，嘴角竟挂着一抹诡异满足的笑。",
            "他紧紧回抱住你，力道大得惊人，似乎想通过这种痛苦的链接确认你真的存在。"
        ],
        reject_woohoo: [
            "他惊慌失措地推开半步，拼命抓挠自己的手臂，低头嘟囔着自己此时肮脏得不配被触碰。",
            "他慌乱地整理好你的衣襟，随后蜷缩到床角，神色自责得像是犯了什么滔天大罪。"
        ],
        breakup: [
            "他脸色瞬间惨白如死灰，膝盖一软跌跪在你面前，语无伦次地试图挽留。",
            "他呆滞地站在原地，看着你远去的方向，眼神一点点熄灭，最后彻底化为虚无。"
        ],
        reject_breakup: [
            "他死死拽住你的衣角不肯松手，眼神从哀求逐渐转向一种令人胆寒的偏执与疯狂。",
            "他跪在门槛上，以头抢地，疯狂地承诺愿意为了留下而放弃最后一丝做人的尊严。"
        ],
        reject_pregnancy: [
            "他诚惶诚恐地护住自己的肚子，动作甚至显得有些滑稽，因为过于紧张而连连摆手。",
            "他盯着那腹中的生灵，眼底闪过一丝自卑，卑微地认为自己这种人不配拥有延续。"
        ]
    }
};

const FIXED_NPC_DIALOGUE = {
    // === 🐕 莫离 (Key: MO_LI) ===
    // 关键词：忙碌掩饰、低姿态、无声的守候
    "MO_LI": {
        chat: [
            "正拿着抹布擦拭桌椅，见你进来，手里的动作一顿，立刻把最干净的那把椅子拉到了你面前。",
            "默默给你倒了一杯温水，试了试杯壁的温度，才小心翼翼地推到你手边。",
            "正在院子里劈柴，听到你的脚步声，立刻停下动作，局促地擦了擦额头上的汗，冲你憨笑。"
        ],
        romance_single: [ // 纯爱：不敢置信
            "脸瞬间红到了耳根，手足无措地站在原地，连视线都不敢与你接触，呼吸却变得急促。",
            "僵硬了片刻，随后像是对待稀世珍宝一般，颤抖着指尖触碰你的脸颊。",
            "顺从地闭上眼睛，睫毛微微颤动，一副任由你处置的乖顺模样。"
        ],
        romance_affair: [ // 偷情：负罪感与渴望
            "咬紧了下唇，直到泛出一丝惨白。他猛地吹灭了蜡烛，将那份见不得光的热切藏进黑暗里。",
            "身子微微发抖，却还是紧紧抓住了你的手腕，仿佛一个溺水的人。",
            "没有说话，只是把脸深深埋进你的颈窝，温热的液体无声地晕开了你的衣领。"
        ]
    },

    // === 🦁 沈叙 (Key: SHEN_PA) ===
    // 关键词：假装不在意、肢体僵硬、压抑后的爆发
    "SHEN_PA": {
        chat: [
            "不紧不慢地合上手中的书卷，抬眼看向你。",
            "为你斟了一盏灵茶，修长的手指轻轻搭在杯壁上试了试温度，确认不烫后才推到你面前。",
            "见你发梢沾了些许晨露，自然地抬手为你拂去。"
        ],
        romance_single: [ // 傲娇：口嫌体正直
            "耐心地替你拆下发髻上繁琐的珠钗，随着满头青丝散落，他眼底的笑意才真正化开。",
            "厚重的罗帐如水般倾泻而下，将这一方天地与屋外的清冷彻底隔绝。",
            "窗外的月光被云层遮住的瞬间，布料摩擦的窸窣声在黑暗中显得格外清晰。"
        ],
        romance_affair: [ // 偷情：背德、报复性占有
           "门外的游廊传来巡夜弟子的脚步声，他却连眼皮都未抬一下，甚至还有闲情雅致替你理顺微乱的鬓角。",
            "食指竖在唇边做了一个噤声的手势，眼底却含着笑，把你拉进床帐深处的阴影里。",
            "没有丝毫的慌张或负罪感，只是细致地吻去你额角的汗珠。"
        ]
    },

    // === 💊 莫问 (Key: MO_PA) ===
    // 关键词：专业动作掩饰、长辈的克制、最后一道防线崩塌
    "MO_PA": {
        chat: [
            "头也没抬，只是指了指对面的蒲团，示意你坐下伸手把脉，神情一如既往的淡漠。",
            "正在分拣草药，见你来了，手里的动作慢了下来，指尖无意识地捻碎了一片甘草叶。",
            "轻轻叹了口气，起身关上了被风吹开的窗户，背对着你站了许久才转过身来。"
        ],
        romance_single: [ // 老房子着火
            "闭了闭眼，发出一声极轻的叹息，随后卸下了所有的防备，缓缓将你揽入怀中。",
            "那双惯常抓药的手着淡淡的草药香，极其缓慢地抚过你的眉眼。",
            "你摘下了他平日里象征家主威严的发冠，任由他满头青丝散落在榻上。"
        ],
        romance_affair: [ // 禁忌：理智崩断
            "满桌的医书散落在地，不过此时你与他都无暇顾及。",
            "用那双微凉的手捂住了你的嘴，在这个充满药香的房间里行那荒唐之事。",
            "眼神复杂地看了你一眼，事后一言不发，借着微弱的月光细致地为你整理衣襟，神情恢复了平日的淡漠。"
        ]
    },

    // === ⚔️ 陆斩风 (Key: LU_ZF) ===
    // 关键词：像剑一样直、不知所措、笨拙的温柔
    "LU_ZF": {
        chat: [
            "随手折断一根枯枝，为你演示了一招刚才你气息凝滞处的破解之法。",
            "并没有多余的寒暄，只是拔出佩剑，放慢动作在你面前舞了一套剑花，随后静立一旁。",
            "难得地露出一丝极浅的笑意，他指了指身侧的位置，示意你一同感悟这山间剑意。"
        ],
        romance_single: [ // 铁汉柔情：剑穗摇曳
            "本命灵剑被随意地挂在床头，鲜红的剑穗随着幔帐的晃动而轻微摇曳。",
            "他小心翼翼地护着你的后脑，掌心厚重的剑茧划过肌肤，带着粗砺的滚烫。",
           "窗外风雪正紧，他下意识地用背脊挡住了透风的窗缝。"
        ],
        romance_affair: [ // 堕落：弃剑（对应你的医书散落）
            "一直视若性命的佩剑此刻孤零零地躺在冰冷的地上，映照出墙上纠缠在一起的影子，很快便被散落的衣物遮盖了光芒。",
            "窗外雷声大作，他却置若罔闻，用一种绝望的姿态，在这场暴雨中与你共沉沦。",
            "死死扣着你的十指，力道大得仿佛要捏碎骨头，眼底最后一点清明被欲望吞噬。"
            ],
    },

    // === 📜 接引师兄 (Key: GUIDE_BRO) ===
    // 关键词：温和微笑、照顾、润物细无声
    "GUIDE_BRO": {
        chat: [
            "他正帮新入门的弟子整理名册，见你过来，立刻放下手里的笔，露出了那个标志性的温和笑容。",
            "他自然地接过你手里的杂物放在一旁，甚至不需要你开口，就已经为你倒好了最爱喝的灵茶。",
            "他站在宗门石阶上，逆着光向你伸出手，衣袖上带着好闻的皂角香气。"
        ],
        romance_single: [ // 暖男上位
            "他眼里的笑意加深，温柔地把你额前的碎发别到耳后，动作熟练得仿佛已经在心里演练过千百遍。",
            "他将你整个人圈进怀里，下巴抵在你的头顶，你能清晰地听到他胸膛里有力的心跳声。",
            "烛火照亮了他眼角的湿意，用一种近乎虔诚的姿态吻着你，"
        ],
        romance_affair: [ // 黑化暖男：隐秘的占有
            "脸上的笑容未变，眼神却变得有些幽深。他轻轻关上了房门，落锁的声音在寂静中格外清晰。",
            "依然温柔，只是这种温柔里多了一丝不容拒绝的强硬，将你牢牢禁锢在他与墙壁之间。",
            "手指抚过你的唇瓣，眼神晦暗不明，仿佛在确认你是真实存在的。"
        ]
    }
};

// 导出 Text 对象 (这里是游戏读取文案的入口)
export const Text = {
    getSpecialDialogue: function(person, type) {
        const gs = window.gameState;
        // === 1. 最高优先级：【孕夫囚禁者】的病态对白 ===
        if (person.id === gs.captorId && person.isPregnant) {
            // 我们只在“交谈(chat)”时触发这种沉重的对白
            if (type === "chat") {
                const pregnantCaptorTexts = [
                    "他抚摸着微隆的小腹，眼神疯魔又卑微：『这便你给我的报应吗？流淌着神血的孩子……我会把他生下来，他将是你我永恒的锁链。』",
                    "『你是我的……即便要我为你孕育后代，我也绝不放你走！』",
                    "他面色苍白，忍着腹中的阵痛，却还要强撑着冷笑：『看啊，天凤老祖，连这天理伦常都在帮我留住你。』",
                    "他低头看着肚子，声音沙哑：『你说，他出生时是会像你多一点，还是像我这个囚禁你的罪人多一点？』"
                ];
                return pregnantCaptorTexts[Math.floor(Math.random() * pregnantCaptorTexts.length)];
            }
        }
        // 1. 检查是否有这个人的专属库 (根据 Key)
        const lib = FIXED_NPC_DIALOGUE[person.key];
        if (!lib) return null; // 不是固定NPC，返回 null，让 actions.js 去走通用逻辑
        // 2. 如果是“普通交谈”
        if (type === "chat") {
            return randomChoice(lib.chat);
        }

        // 3. 如果是“春宵 / 双修”
        if (type === "romance") {
            // === 偷情判定逻辑 ===
            // 判定标准：
            // 1. 玩家当前有配偶 (gameState.spouseId 存在)
            // 2. 且 配偶的ID 不是眼前这个人的ID
            // 3. 且 眼前这个人也不是所谓的“灵魂伴侣”(如果是前世夫妻可能不算偷情，看你设定，这里暂不考虑)
            
            let isAffair = false;
            
            if (gameState.spouseId && gameState.spouseId !== person.id) {
                isAffair = true; // 你有老公/老婆，但睡的不是他/她 -> 偷情！
            }

            if (isAffair) {
                // 返回“偷情/背德”的文本
                return randomChoice(lib.romance_affair);
            } else {
                // 返回“纯爱/单身”的文本 (包括和正牌老公睡)
                return randomChoice(lib.romance_single);
            }
        }
        
        return null;
    },
    // 名字格式化（带点击事件）
    formatName: function(person) {
        return `<span style="cursor:pointer; font-weight:bold; border-bottom:1px dashed #999;" onclick="window.openDetail(${person.id})">${person.name}</span>`;
    },

    // 外貌描述生成
    getAppearanceDesc: function(p) {
        if(p.appearanceDesc && p.appearanceDesc.length > 5) return p.appearanceDesc;
        
        const a = p.appearance;
        // 防报错：如果外观数据不存在，直接返回
        if (!a) return "相貌平平。"; 

        // === 辅助工具：安全获取值 ===
        // 如果数据缺失，返回空字符串，防止报错
        const v = (key) => (a[key] && a[key].val) ? a[key].val : "";

        let skin = v('skins');
        let hairC = v('hair_colors');
        let hairS = v('hair_styles');
        let eyeC = v('eye_colors');
        let eyeS = v('eye_shapes') || v('eyes');
        let face = v('face_shapes');
        let nose = v('noses');
        let lip = v('lips');
        let deco = v('decorations');
        let temp = v('temperaments');
        
        // [新增] 获取眉毛描述
        let brow = v('eyebrows'); 

        // === 拼装句子 (基于你的原版修改) ===
        // 1. 肤色 + 头发
        // 加个判断，防止光头时显示“留着一头黑色的。”这种怪句子
        let hairDesc = hairS ? `留着一头${hairC}的${hairS}` : `留着光头`;
        let desc = `肤色${skin}，${hairDesc}。`;

        // 2. 脸 + 眉毛 + 眼睛
        desc += `生得一张${face}，`;
        
        // 这里把眉毛加进去
        if (brow) {
            desc += `眉如${brow}，`;
        }
        
        desc += `双目是一对${eyeC}的${eyeS}，气质${temp}。`;
        
        // 3. 特征 / 五官
        if (deco && deco !== "无") {
            desc += `尤为引人注目的是${deco}。`;
        } else {
            desc += `五官端正，配上${nose}与${lip}，显得十分协调。`;
        }
        
        // 4. 颜值评价 (保留原逻辑，加个安全判断)
        let score = a.beautyScore || 0;
        if (score >= 35) desc += " <span style='color:#e91e63; font-weight:bold;'>【绝世容颜】</span>";
        else if (score >= 25) desc += " <span style='color:#9b59b6;'>【天生丽质】</span>";
        else if (score <= 10) desc += " <span style='color:#7f8c8d;'>【其貌不扬】</span>";

        return desc;
    },

    // 交互文案核心逻辑
    Dialogue: {
        // 1. 获取交谈文本
        getTalk: function(p, isChild, isSpouse, spouseId) {
            // 获取性格名称
            let pName = p.personality.name; 
            let lib = NEW_DIALOGUE_LIB[pName] || NEW_DIALOGUE_LIB["温润"]; // 兜底

            // 入魔判定
            if (p.isDemonic) {
                 return randomChoice(lib.demonic) + " <span style='color:#c0392b; font-weight:bold;'>[入魔]</span>";
            }
            // 亲子判定
            if (isChild && p.age < 18) {
                return "（乖巧地）“母亲大人安好，孩儿今日有好好修炼。”";
            }
            // 获取当前关系状态
            let state = getRelationState(p, isSpouse);
            
            // 随机抽取
            let lines = lib[state] || lib["stranger"];
            return randomChoice(lines);
        },

        // 2. 双修/亲热文本
        getWoohoo: function(p, isSpouse, spouseId, isForce = false) {
             let pName = p.personality.name;
             let lib = NEW_DIALOGUE_LIB[pName] || NEW_DIALOGUE_LIB["温润"];

             if (isForce) {
                 return randomChoice(lib.woohoo_force);
             } else {
                 return randomChoice(lib.woohoo_normal);
             }
        },

        // 3. 拒绝亲热 (怀孕/生病/心情不好)
        getWoohooRefusal: function(p) {
            let pName = p.personality.name;
            let lib = NEW_DIALOGUE_LIB[pName] || NEW_DIALOGUE_LIB["温润"];
            return randomChoice(lib.reject_woohoo);
        },

        // 4. 离婚/分手文案
        getBreakup: function(p, type) {
            let pName = p.personality.name;
            let lib = NEW_DIALOGUE_LIB[pName] || NEW_DIALOGUE_LIB["温润"];

            if (type === 'divorce') { // 协议离婚
                return randomChoice(lib.breakup);
            }
            // 强行休弃暂时返回通用，或者也可以加在lib里
            return "“我们……就这样结束了吗？”";
        },

        // 5. 怀孕时的拒绝文案
        getPregnancyRefusal: function(p, isPlayerChild) {
            if (isPlayerChild) {
                 // 这里简单处理，如果你是孩子父亲，用性格库的拒绝
                 let pName = p.personality.name;
                 let lib = NEW_DIALOGUE_LIB[pName] || NEW_DIALOGUE_LIB["温润"];
                 return randomChoice(lib.reject_pregnancy);
            }
            return `面色冰冷，语气决绝：“我有孕在身，不便动气。你我之间的旧账，等孩子出生后再算不迟！”`;
        },

        // 6. 拒绝离婚文案
        getDivorceRefusal: function(p) {
            let pName = p.personality.name;
            let lib = NEW_DIALOGUE_LIB[pName] || NEW_DIALOGUE_LIB["温润"];
            return randomChoice(lib.reject_breakup);
        },
        SoulEcho: {
    // 场景：前夫/旧情人 产生了怀疑
    suspicion: [
        "看着你倒茶的手势，眼神突然恍惚了一下。",
        "当你说话时，他猛地抬起头，眼中闪过一丝不可置信。",
        "他怔怔看着你，感觉好似故人归。"
    ],
    manipulation: [
            "你在他失神之际，那个唯有两人知晓的隐秘动作让他的理智在刹那间如枯木般寸寸崩裂。",
            "指尖漫不经心地挑起那枚旧物，在光影交错间投下一抹让他脊背生寒的、属于故人的傲慢笑意。",
            "借着这副崭新的皮囊，在那双满是慈爱的眼中，你毫不掩饰地展露出冰冷的审视。"
        ],
    
    // 场景：彻底识破（确认是你）
    recognition: [
        "一把抓住了你的手腕，声音颤抖着问你回来了，对吗？"
    ],

    // 场景：仇人识破
    nemesis: [
        "突然冷笑起来，狠狠瞪了你一眼。",
        "拔剑指向你，仰天大笑要报仇雪恨。”"
    ]
}
        
},
Logs: {
            birthTitle: (f, s) => s === f ? "夫君" : "知己",
            itemUsed: (n, t, v) => t === 'none' ? `你使用了 [${n}]，没什么反应。` : `你使用了 [${n}]，${t}增加 ${v} 点。`,
            npcFight: (p1, p2) => `【传闻】${Text.formatName(p1)} 与 ${Text.formatName(p2)} 为争夺机缘大打出手，双方不欢而散。`,
            npcChat: (p1, p2) => `【传闻】有人看到 ${Text.formatName(p1)} 与 ${Text.formatName(p2)} 在茶楼相谈甚欢。`,
            npcLove: (p1, p2) => `【八卦】${Text.formatName(p1)} 竟然向 ${Text.formatName(p2)} 表白了！然而被无情拒绝。`,
            saveSuccess: "✅ 存档成功！",
            loadSuccess: "📂 读档成功！",
            noSave: "❌ 没有找到存档记录。"
        }
    }
    export const INTRO_STORY = [
    "【洪荒·终焉】",
    "上古天凤一族拥有【不死神性】，血脉霸道无匹，曾统御万妖，屹立于修真界之巅。",
    "然怀璧其罪，遭诸神围猎，天凤陨落，如今你作为仅存的火种，不得不隐姓埋名。",
    "你立誓重铸天凤荣光！利用血脉的【吞噬进化】特性，通过一代代繁衍与提纯，终将君临天下。",
    "此刻，你化名【云雾衡】拜入青云宗，幼年玩伴莫离相随左右，山门前的接引师兄正等着引你入道……"
];

// === 【更新】最终版结局故事库 ===
export const ENDING_STORY = {
    RESONANCE: [
        "修真界所有的生灵皆感到心神猛地一颤。",
        "无不惊骇地抬头望向虚空。"
    ],
    FAREWELL: [
        "你站在天穹之巅，俯瞰着下方的众生。",
        "那些曾经的人或物……此刻在你的眼中，竟是如此索然无味。",
        "你轻轻合上双眼，不再看这片已经被你玩弄的尘世。",
        "伴随着一声划破时空的凤鸣，你化作一道璀璨的金芒，消失在位面尽头。"
    ]
};
// === 【新增】修罗场/嫉妒对话库 ===
export const JEALOUSY_TEXTS = {
    // 1. 阴阳怪气型 (清贵、市侩、儒雅)
    SARCASTIC: [
        "哟，云道友还舍得回来？我还以为你在那温柔乡里乐不思蜀了呢。",
        "听闻你上月在别处玩得颇为尽兴，想必我这儿的残茶剩饭是入不了你的眼了。",
        "呵呵，那位的滋味想必极好，竟让你连传音符都忘了回？"
    ],
    // 2. 卑微自怜型 (温润、痴绝)
    PITIFUL: [
        "是我哪里做得不好吗？为何你宁愿去找他，也不愿多看我一眼……",
        "没关系的，只要你心里还有我的一角余地，我便知足了。",
        "你身上有他的味道……是我不配独占你吗？"
    ],
    // 3. 暴躁质问型 (骄阳、疏狂、凶戾)
    AGGRESSIVE: [
        "那个废物哪点比我强？你竟敢背着我去寻他！",
        "闭嘴！我不想听你的解释。要么杀了他，要么我亲自动手！",
        "云道友，你的胃口真是越来越大了，也不怕把自己撑死？"
    ]
};
window.JEALOUSY_TEXTS = JEALOUSY_TEXTS


